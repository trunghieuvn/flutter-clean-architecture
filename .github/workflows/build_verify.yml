name: Verify Compile

on:
  workflow_dispatch:

# Cancel c√°c workflow c≈© khi c√≥ build m·ªõi
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: "3.35"

jobs:
  build_apk:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout (Optimized)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 1.5. Clean up runner disk space üßπ
        run: |
          echo "Disk space before cleanup:"
          df -h

          # X√≥a c√°c g√≥i c√†i ƒë·∫∑t s·∫µn kh√¥ng c·∫ßn thi·∫øt (song song ƒë·ªÉ nhanh h∆°n)
          sudo rm -rf /usr/share/dotnet &
          sudo rm -rf /opt/ghc &
          sudo rm -rf /usr/local/lib/android/sdk/build-tools/30.0.3 &
          wait

          # D·ªçn d·∫πp cache
          sudo apt-get clean
          docker system prune -a -f

          echo "Disk space after cleanup:"
          df -h

      - name: 2. Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          # flutter-version: 3.32.8
          cache: true
          cache-key: flutter-${{ env.FLUTTER_VERSION }}-${{ runner.os }}

      - name: 3. Cache Pub Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/.dart_tool
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: 4. Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: 5. Get Flutter dependencies
        run: flutter pub get

      - name: 6. Build APK
        run: flutter build apk

  build_ios:
    runs-on: macos-latest
    steps:
      - name: 1. Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 2. Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          # flutter-version: 3.32.8
          cache: true
          cache-key: flutter-${{ env.FLUTTER_VERSION }}-${{ runner.os }}

      - name: 3. Cache Pub Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/.dart_tool
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: 4. Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
            ~/.cocoapods
          key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: 5. Cache iOS Build
        uses: actions/cache@v4
        with:
          path: |
            ios/build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-ios-build-${{ hashFiles('**/Podfile.lock', '**/*.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-ios-build-

      - name: 6. Get Flutter dependencies
        run: flutter pub get

      - name: 7. Pod Install (if needed)
        working-directory: ios
        run: |
          if [ ! -d "Pods" ]; then
            pod install --repo-update
          else
            echo "Pods cached, skipping pod install"
          fi

      - name: 8. Build iOS
        run: flutter build ios --no-codesign
